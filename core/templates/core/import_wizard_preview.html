{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Import Transactions - Preview</h2>
  <p>Total rows: {{ total }} | Valid: {{ valid_count }} | Invalid: {{ error_rows|length }}</p>
  {% if error_rows %}
  <table class="table table-sm">
    <thead><tr><th>Row</th><th>Errors</th></tr></thead>
    <tbody>
      {% for row in error_rows %}
      <tr><td>{{ row.index }}</td><td>{{ row.errors }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  <form method="post" action="{% url 'transaction_import_wizard_commit' %}" id="confirm-form" class="mt-3">
    {% csrf_token %}
    <button type="submit" class="btn btn-success" id="confirm-btn">Confirm Import</button>
  </form>
  <div id="progress-section" class="mt-3 d-none">
    <div class="progress">
      <div class="progress-bar progress-bar-striped progress-bar-animated" id="progress-bar">
        <span id="progress-text">0%</span>
      </div>
    </div>
    <div id="progress-details" class="mt-2 text-muted">Preparing...</div>
  </div>
</div>
<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('confirm-form');
  const btn = document.getElementById('confirm-btn');
  const section = document.getElementById('progress-section');
  const bar = document.getElementById('progress-bar');
  const text = document.getElementById('progress-text');
  const details = document.getElementById('progress-details');
  form.addEventListener('submit', function() {
    btn.disabled = true;
    section.classList.remove('d-none');
    let p = 0;
    const steps = ['Validating...', 'Importing...', 'Finalizing...'];
    const interval = setInterval(()=> {
      p += 20;
      if (p >= 100) {p = 100; clearInterval(interval);}
      bar.style.width = p + '%';
      text.textContent = p + '%';
      details.textContent = steps[Math.min(steps.length-1, Math.floor(p/40))];
    }, 200);
  });
});
</script>
{% endblock %}
