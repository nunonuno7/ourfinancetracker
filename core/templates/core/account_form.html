{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">{% if form.instance.pk %}Edit Account{% else %}New Account{% endif %}</h2>

  <form method="post" id="account-form" novalidate>
    {% csrf_token %}
    <div style="display:none">
  {{ form.non_field_errors }}
</div>

    <input type="hidden" name="confirm_merge" id="confirm_merge" value="false">

    <div class="mb-3">
      <label for="{{ form.name.id_for_label }}" class="form-label">Name</label>
      {{ form.name|add_class:"form-control" }}
      {{ form.name.errors }}
    </div>

    <div class="mb-3">
      <label for="{{ form.account_type.id_for_label }}" class="form-label">Type</label>
      {{ form.account_type|add_class:"form-select" }}
      {{ form.account_type.errors }}
    </div>

    <div class="mb-3">
      <label for="{{ form.currency.id_for_label }}" class="form-label">Currency</label>
      {{ form.currency|add_class:"form-select" }}
      {{ form.currency.errors }}
    </div>

    <div class="d-flex gap-2">
      <button type="button" class="btn btn-success" onclick="confirmAccountMerge()">üíæ Save</button>

      {% if form.instance.pk %}
        <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">üóëÔ∏è Delete</button>
      {% endif %}

      <a href="{% url 'account_list' %}" class="btn btn-secondary">‚Üê Back</a>
    </div>
  </form>
</div>

<script>
function confirmAccountMerge() {
  const form = document.getElementById("account-form");
  const confirmField = document.getElementById("confirm_merge");

  const errorEl = document.querySelector(".nonfield ul li");
  const isMergeWarning = errorEl && errorEl.innerText.includes("Queres fundir os saldos");

  if (isMergeWarning) {
    if (confirm("‚ö† J√° existe uma conta com esse nome. Queres fundir os saldos?")) {
      confirmField.value = "true";
      form.submit();
    }
    return;
  }

  form.submit();
}
</script>


{% endblock %}
