{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container mt-4">
  <!-- Cabe√ßalho e bot√£o voltar -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">‚¨Ü Import Transactions from Excel</h2>
    <a href="{% url 'transaction_list' %}" class="btn btn-outline-secondary">‚Üê Back to List</a>
  </div>

  <!-- Messages are displayed in base.html template at the top -->

  <!-- Formul√°rio de upload -->
  <form method="post" action="{% url 'transaction_import_xlsx' %}" enctype="multipart/form-data" class="card shadow-sm p-4">
    {% csrf_token %}

    <div class="mb-3">
      <label for="id_file" class="form-label">Select Excel file</label>
      <input type="file" name="file" id="id_file" class="form-control" accept=".xlsx" required>

      <div class="form-text mt-2">
        <strong>Required columns (must match these exactly):</strong>
        <ul class="mb-0 ps-3">
          <li><code>Date</code> ‚Äì format: <code>YYYY-MM-DD</code> (e.g. <code>2025-06-15</code>) or Excel date format</li>
          <li><code>Type</code> ‚Äì one of: <code>Income</code>, <code>Expense</code>, <code>Investment</code>, <code>Transfer</code>, <code>Adjustment</code> (or short codes: IN, EX, IV, TR, AJ)</li>
          <li><code>Amount</code> ‚Äì numeric value (e.g. <code>150.00</code> or <code>-250.00</code> for withdrawals)</li>
          <li><code>Category</code> ‚Äì free text (will be created if not found)</li>
          <li><code>Account</code> ‚Äì account name (will be created if not found)</li>
          <li><code>Tags</code> ‚Äì optional, comma-separated tags (e.g. <code>food,monthly,business</code>)</li>
        </ul>

        <div class="mt-3">
          <strong>Troubleshooting tips:</strong>
          <ul class="small text-muted">
            <li>Ensure your Excel file has data starting from row 2 (row 1 should contain headers)</li>
            <li>Remove any completely empty rows from your file</li>
            <li>Make sure Date, Type, Amount, Category, and Account columns have values</li>
            <li>Date format should be recognizable (YYYY-MM-DD preferred)</li>
            <li>Amount should be numbers only (no currency symbols)</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Bot√µes -->
    <div class="d-flex justify-content-between">
      <button type="submit" class="btn btn-success" id="import-btn">
        <span id="import-text">üì• Import Transactions</span>
        <span id="import-loading" class="d-none">
          <span class="spinner-border spinner-border-sm me-2" role="status"></span>
          Importing...
        </span>
      </button>
      <a href="{% url 'import_transactions_template_xlsx' %}" class="btn btn-outline-primary">üìÑ Download Template</a>
    </div>

    <!-- Progress Section -->
    <div id="progress-section" class="mt-3 d-none">
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">
            <i class="fas fa-upload me-2"></i>
            Import Progress
          </h6>
          <div class="progress mb-3 h-25">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary w-0"
                 role="progressbar" id="progress-bar">
              <span id="progress-text" class="fw-bold">0%</span>
            </div>
          </div>
          <div id="progress-details" class="text-muted">
            Preparing import...
          </div>
          <small class="text-muted d-block mt-2">
            <i class="fas fa-info-circle me-1"></i>
            Please wait, do not close this window...
          </small>
        </div>
      </div>
    </div>
    </div>
  </form>
</div>

<!-- Bootstrap JS (para alertas e bot√£o fechar) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const importBtn = document.getElementById('import-btn');
    const importText = document.getElementById('import-text');
    const importLoading = document.getElementById('import-loading');
    const progressSection = document.getElementById('progress-section');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressDetails = document.getElementById('progress-details');

    form.addEventListener('submit', function(e) {
        const fileInput = document.getElementById('id_file');
        if (!fileInput.files.length) {
            e.preventDefault();
            alert('Please select a file first.');
            return;
        }

        // Show loading state
        importBtn.disabled = true;
        importText.classList.add('d-none');
        importLoading.classList.remove('d-none');

        // Show progress section
        progressSection.classList.remove('d-none');

        // Start with initial progress
        updateProgress(5, 'Starting import process...');

        // Simulate progress steps since Django upload is synchronous
        setTimeout(() => {
            simulateProgress();
        }, 200);
    });

    function simulateProgress() {
        let progress = 0;
        const baseIncrement = 50 / 12; // Faster initial progress

        const messages = [
            'Uploading file...',
            'Validating Excel format...',
            'Reading transaction data...',
            'Preparing bulk operations...',
            'Creating periods in bulk...',
            'Creating categories in bulk...',
            'Creating accounts in bulk...',
            'Bulk inserting transactions...'
        ];

        const interval = setInterval(() => {
            // Faster increment for optimized bulk operations
            let increment = baseIncrement;
            if (progress > 25) increment *= 1.2; // Speed up in middle
            if (progress > 40) increment *= 0.8; // Slow down near end

            progress += increment;

            if (progress >= 50) {
                clearInterval(interval);
                // Final steps for bulk operations
                finalProgressSteps();
                return;
            }

            const messageIndex = Math.floor(progress / 7);
            const message = messages[messageIndex] || 'Processing bulk import...';

            updateProgress(Math.min(progress, 50), `${message} (${Math.floor(progress)}%)`);
        }, 200); // Faster updates

        return interval;
    }

    function finalProgressSteps() {
        // Optimized final steps for bulk operations (50% to 95%)
        const finalSteps = [
            { percent: 60, message: 'Bulk creating periods and accounts...', delay: 400 },
            { percent: 70, message: 'Bulk inserting transactions...', delay: 500 },
            { percent: 80, message: 'Processing relationships...', delay: 400 },
            { percent: 88, message: 'Clearing cache...', delay: 300 },
            { percent: 93, message: 'Finalizing import...', delay: 300 },
            { percent: 95, message: 'Preparing redirect...', delay: 200 }
        ];

        let stepIndex = 0;
        const stepInterval = setInterval(() => {
            if (stepIndex >= finalSteps.length) {
                clearInterval(stepInterval);
                return;
            }

            const step = finalSteps[stepIndex];
            updateProgress(step.percent, step.message);
            stepIndex++;
        }, finalSteps[stepIndex]?.delay || 400); // Faster intervals
    }

    function updateProgress(percent, details) {
        progressBar.style.width = percent + '%';
        progressText.textContent = percent + '%';
        progressDetails.textContent = details;

        // Add success styling when complete
        if (percent >= 100) {
            progressBar.classList.remove('bg-primary');
            progressBar.classList.add('bg-success');
            progressBar.classList.remove('progress-bar-animated');
            progressDetails.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i>Import completed! Redirecting...';
        } else if (percent >= 95) {
            progressDetails.innerHTML = '<strong>Almost done...</strong> Finishing import process...';
        }
    }

    // Handle file size validation
    const fileInput = document.getElementById('id_file');
    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file && file.size > 10 * 1024 * 1024) { // 10MB limit
            alert('File size too large. Please select a file smaller than 10MB.');
            this.value = '';
        }
    });
});
</script>
{% endblock %}