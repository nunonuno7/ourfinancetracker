{% extends "base.html" %}
{% load static %}
{% load filtros %}

{% block content %}
<h2 class="mb-3">Account Balances</h2>

<!-- YEAR / MONTH NAV -->
<div class="d-flex align-items-center mb-3">
  <a class="btn btn-outline-secondary me-2"
     href="?year={{ year }}&month={{ month|add:'-1' }}">
    â€¹
  </a>
  <input type="month" id="selector"
         value="{{ year }}-{{ month|stringformat:'02d' }}"
         onchange="window.location='?month='+this.value.split('-')[1]+'&year='+this.value.split('-')[0];">
  <a class="btn btn-outline-secondary ms-2"
     href="?year={{ year }}&month={{ month|add:'1' }}">
    â€º
  </a>
</div>

<form method="post">
  {% csrf_token %}
  {{ formset.management_form }}
  <table class="table align-middle">
    <thead>
      <tr>
        <th>Account</th>
        <th class="text-end">Balance (â‚¬)</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="balance-table">
      {% for form in formset %}
        <tr class="form-row">


<td>
  {{ form.account }}
  {{ form.id }}  {# campo hidden obrigatÃ³rio para Django manter integridade do formset #}
</td>
<td class="text-end">
  {{ form.reported_balance }}
</td>





          <td>
            {% if form.instance.pk %}
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="markForDelete(this)">
                Ã—
              </button>
              {{ form.DELETE.as_hidden }}
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="d-flex justify-content-between">
    <button type="submit" class="btn btn-primary">ðŸ’¾ Save</button>
    <button type="button" class="btn btn-secondary" onclick="addRow()">ï¼‹ Add Account</button>
  </div>
</form>

<a href="{% url 'account_list' %}" class="btn btn-outline-secondary mt-3">Manage Accounts</a>

<script>
function markForDelete(btn) {
  const row = btn.closest("tr");
  row.style.display = "none";

  const deleteInput = row.querySelector("input[name$='-DELETE']");
  if (deleteInput) {
    deleteInput.value = 'on';  // marca como a eliminar
  }
}

function addRow() {
  const table = document.getElementById("balance-table");
  const totalForms = document.getElementById("id_form-TOTAL_FORMS");
  const newIndex = parseInt(totalForms.value);

  const rowHtml = `
    <tr class="form-row">
      <td>
        <input type="text" name="form-${newIndex}-account" class="form-control" />
        <input type="hidden" name="form-${newIndex}-id" />
      </td>
      <td class="text-end">
        <input type="number" step="0.01" name="form-${newIndex}-reported_balance" class="form-control text-end" />
      </td>
      <td>
        <input type="hidden" name="form-${newIndex}-DELETE" value="off" />
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="markForDelete(this)">Ã—</button>
      </td>
    </tr>
  `;
  table.insertAdjacentHTML("beforeend", rowHtml);
  totalForms.value = newIndex + 1;
}
</script>


{% endblock %}
