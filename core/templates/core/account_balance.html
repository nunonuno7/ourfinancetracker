{% extends "base.html" %}
{% load static %}
{% load filtros %}

{% block content %}
<div class="container-fluid">
  {{ available_accounts|json_script:"available-accounts" }}
  <div class="row">
    <div class="col-12">
      <!-- Header Section -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">üí∞ Account Balances</h4>
            <div class="d-flex align-items-center gap-2">
              <!-- Month Navigation -->
              <div class="btn-group" role="group">
                <a class="btn btn-outline-secondary btn-sm" href="?year={{ year }}&month={{ month|add:'-1' }}">‚Äπ Prev</a>
                <input type="month" id="selector" value="{{ year }}-{{ month|stringformat:'02d' }}" 
                       onchange="window.location='?month='+this.value.split('-')[1]+'&year='+this.value.split('-')[0];"
                       class="form-control form-control-sm w-140">
                <a class="btn btn-outline-secondary btn-sm" href="?year={{ year }}&month={{ month|add:'1' }}">Next ‚Ä∫</a>
              </div>

              <!-- Actions -->
              <div class="btn-group" role="group">
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#exportModal">
                  üìä Export
                </button>
                <a href="{% url 'account_balance_import_xlsx' %}" class="btn btn-outline-success btn-sm">
                  üì• Import
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="card-body py-2">
          <div class="row text-center">
            <div class="col-md-3">
              <div class="text-muted small">Total Balance</div>
              <div class="h5 mb-0 text-primary">{{ grand_total|formatar_moeda }}</div>
            </div>
            <div class="col-md-3">
              <div class="text-muted small">Account Groups</div>
              <div class="h5 mb-0">{{ grouped_forms|length }}</div>
            </div>
            <div class="col-md-3">
              <div class="text-muted small">Period</div>
              <div class="h5 mb-0">{{ selected_month|date:"M Y" }}</div>
            </div>
            <div class="col-md-3">
              <div class="text-muted small">Quick Actions</div>
              <div>
                <button type="button" id="copy-previous-btn" class="btn btn-outline-info btn-sm">üìã Copy Previous</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Main Form -->
  <form method="post">
    {% csrf_token %}
    {{ formset.management_form }}

    {% for key, forms in grouped_forms.items %}
      {% with account_type=key.0 currency=key.1 %}
        <div class="card shadow-sm mb-3">
          <div class="card-header bg-light py-2">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">üíº {{ account_type }} ‚Äì {{ currency }}</h6>
              <span class="badge bg-primary">{{ totals_by_group|get_item:key|formatar_moeda }}</span>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="text-center w-40">üì±</th>
                    <th>Account Name</th>
                    <th class="text-end w-180">Balance</th>
                    <th class="text-center w-60">Actions</th>
                  </tr>
                </thead>
                <tbody class="sortable-table" data-reorder-url="{% url 'account_reorder' %}"
                       {% if account_type == "Savings" and currency == "EUR" %}id="balance-table"{% endif %}>
                  {% for form in forms %}
                    <tr class="form-row" data-id="{{ form.instance.account.id|default:'' }}" data-account-name="{{ form.instance.account.name|default:'' }}">
                      <td class="text-center handle cursor-grab" title="Drag to reorder">
                        <span class="handle-icon">‚ãÆ‚ãÆ</span>
                      </td>
                      <td>
                        {{ form.account.as_hidden }}
                        {{ form.id }}
                        <span>{{ form.instance.account.name }}</span>
                      </td>
                      <td class="text-end">
                        {{ form.reported_balance }}
                      </td>
                      <td class="text-center">
                        {% if form.instance.pk %}
                          {{ form.DELETE.as_hidden }}
                          <button type="button" class="btn btn-sm btn-outline-danger delete-btn"
                                  data-id="{{ form.instance.pk }}" title="Delete">üóëÔ∏è</button>
                        {% else %}
                          <button type="button" class="btn btn-sm btn-outline-secondary remove-row-btn" title="Remove">‚ùå</button>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endwith %}
    {% endfor %}

  <!-- Action Bar -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-4">
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-success">üíæ Save Changes</button>
              <button type="button" id="add-row-btn" class="btn btn-outline-primary">‚ûï Add Account</button>
            </div>
          </div>

          <div class="col-md-4 text-center">
            <div class="h5 mb-0" id="total-balance">{{ grand_total|formatar_moeda }}</div>
            <small class="text-muted">Live Total</small>
          </div>

          <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
              <button class="btn btn-outline-secondary btn-sm" id="toggle-zeros-btn" data-state="hide">üëÅ Toggle Zeros</button>
              <a href="{% url 'account_list' %}" class="btn btn-outline-info btn-sm">‚öôÔ∏è Manage Accounts</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- New Row Template -->
  <template id="empty-form-template">
    <tr class="form-row">
      <td class="text-center handle cursor-grab">‚ãÆ‚ãÆ</td>
      <td>
        <select class="form-select account-select"></select>
        <input type="hidden" name="form-__prefix__-account" />
        <input type="hidden" name="form-__prefix__-id" />
      </td>
      <td class="text-end">
        <input type="number" step="0.01" name="form-__prefix__-reported_balance"
               class="form-control text-end" placeholder="0.00" />
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="Remove">‚ùå</button>
      </td>
    </tr>
  </template>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <form method="get" action="{% url 'account_balance_export_xlsx' %}">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h6 class="modal-title" id="exportModalLabel">üìä Export to Excel</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="start" class="form-label">From Period:</label>
            <input type="month" name="start" id="start" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="end" class="form-label">To Period:</label>
            <input type="month" name="end" id="end" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary btn-sm">üì• Download</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-narrow">
    <div class="modal-content modal-rounded">
      <div class="modal-body text-center py-4">
        <p class="mb-3 delete-confirm-text">Are you sure you want to delete this balance?</p>
        <div class="d-flex justify-content-center gap-3">
          <button type="button" class="btn btn-primary px-4" id="confirm-delete-btn">OK</button>
          <button type="button" class="btn btn-secondary px-3" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="{% static 'js/account_balance.js' %}" defer></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{% static 'js/drag_reorder.js' %}" defer></script>
{% endblock %}