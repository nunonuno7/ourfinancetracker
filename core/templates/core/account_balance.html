{% extends "base.html" %}
{% load static %}
{% load filtros %}

{% block content %}
<h2 class="mb-3">Account Balances</h2>

<!-- YEAR / MONTH NAV -->
<div class="d-flex align-items-center mb-3">
  <a class="btn btn-outline-secondary me-2"
     href="?year={{ year }}&month={{ month|add:'-1' }}">
    ‚Äπ
  </a>
  <label for="selector" class="form-label me-2">Select month:</label>
  <input type="month" id="selector"
         value="{{ year }}-{{ month|stringformat:'02d' }}"
         onchange="window.location='?month='+this.value.split('-')[1]+'&year='+this.value.split('-')[0];">
  <a class="btn btn-outline-secondary ms-2"
     href="?year={{ year }}&month={{ month|add:'1' }}">
    ‚Ä∫
  </a>
</div>

{% if messages %}
  <div class="mt-3" id="message-container">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
  <script>
    setTimeout(() => {
      const container = document.getElementById("message-container");
      if (container) {
        container.querySelectorAll(".alert").forEach(alert => {
          alert.classList.remove("show");
          alert.classList.add("fade");
          setTimeout(() => alert.remove(), 500);
        });
      }
    }, 4000);
  </script>
{% endif %}


<!-- Action buttons -->
<div class="mb-3 d-flex gap-2">
  <button type="button" id="copy-previous-btn" class="btn btn-outline-info">‚ü≤ Copy Previous Month</button>
  <button type="button" id="reset-btn" class="btn btn-outline-warning">üßπ Reset Changes</button>
  <button type="button" id="toggle-zeros-btn" class="btn btn-outline-secondary" data-state="hide">üëÅ Show All</button>
</div>

<form method="post">
  {% csrf_token %}
  {{ formset.management_form }}
  <table class="table align-middle">
    <thead>
      <tr>
        <th>Account</th>
        <th class="text-end">Balance (‚Ç¨)</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="balance-table">
      {% for form in formset %}
        <tr class="form-row {% if not form.instance.pk %}table-warning{% endif %}">
          <td>{{ form.account }}{{ form.id }}</td>
          <td class="text-end">{{ form.reported_balance }}</td>
          <td>
            {% if form.instance.pk %}
              {{ form.DELETE.as_hidden }}
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAccount('{{ form.instance.pk }}', this)">√ó</button>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th>Total</th>
        <th class="text-end" id="total-balance">‚Äî</th>
        <th></th>
      </tr>
    </tfoot>
  </table>

  <div class="d-flex justify-content-between">
    <button type="submit" class="btn btn-primary">üìÇ Save</button>
    <button type="button" id="add-row-btn" class="btn btn-secondary">+ Add Account</button>
  </div>
</form>

<a href="{% url 'account_list' %}" class="btn btn-outline-secondary mt-3">Manage Accounts</a>

<!-- Template for empty row -->
<table class="d-none">
  <tbody>
    <tr id="empty-form-template">
      <td>
        {{ formset.empty_form.account }}
        {{ formset.empty_form.id }}
      </td>
      <td class="text-end">
        {{ formset.empty_form.reported_balance }}
      </td>
      <td></td>
    </tr>
  </tbody>
</table>

{% endblock %}  {# ‚Üê fecha block content aqui #}

{% block extra_js %}
<script src="{% static 'js/account_balance.js' %}"></script>
{% endblock %}