{% extends "base.html" %}
{% load static %}
{% load filtros %}

{% block content %}
<h2 class="mb-3">Account Balances</h2>

<!-- YEAR / MONTH NAV -->
<div class="d-flex align-items-center mb-3">
  <a class="btn btn-outline-secondary me-2"
     href="?year={{ year }}&month={{ month|add:'-1' }}">
    â€¹
  </a>
  <input type="month" id="selector"
         value="{{ year }}-{{ month|stringformat:'02d' }}"
         onchange="window.location='?month='+this.value.split('-')[1]+'&year='+this.value.split('-')[0];">
  <a class="btn btn-outline-secondary ms-2"
     href="?year={{ year }}&month={{ month|add:'1' }}">
    â€º
  </a>
</div>

<form method="post">
  {% csrf_token %}
  {{ formset.management_form }}
  <table class="table align-middle">
    <thead>
      <tr>
        <th>Account</th>
        <th class="text-end">Balance (â‚¬)</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="balance-table">
      {% for form in formset %}
        <tr class="form-row">
          <td>
            {{ form.account }}
            {{ form.id }}
          </td>
          <td class="text-end">
            {{ form.reported_balance }}
          </td>
          <td>
            {% if form.instance.pk %}
              {{ form.DELETE.as_hidden }}
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAccount('{{ form.instance.pk }}', this)">
                Ã—
              </button>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="d-flex justify-content-between">
    <button type="submit" class="btn btn-primary">ðŸ’¾ Save</button>
    <button type="button" class="btn btn-secondary" onclick="addRow()">ï¼‹ Add Account</button>
  </div>
</form>

<a href="{% url 'account_list' %}" class="btn btn-outline-secondary mt-3">Manage Accounts</a>

<script>
function addRow() {
  const table = document.getElementById("balance-table");
  const totalForms = document.getElementById("id_form-TOTAL_FORMS");
  const newIndex = parseInt(totalForms.value);

  const rowHtml = `
    <tr class="form-row">
      <td>
        <input type="text" name="form-${newIndex}-account" class="form-control" />
        <input type="hidden" name="form-${newIndex}-id" />
      </td>
      <td class="text-end">
        <input type="number" step="0.01" name="form-${newIndex}-reported_balance" class="form-control text-end" />
      </td>
      <td></td>
    </tr>
  `;
  table.insertAdjacentHTML("beforeend", rowHtml);
  totalForms.value = newIndex + 1;
}

function deleteAccount(balanceId, button) {
  if (!confirm("Are you sure you want to delete this balance?")) return;

  fetch(`/account-balance/delete/${balanceId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
    },
  })
  .then(response => {
    if (response.ok) {
      const row = button.closest("tr");
      row.remove();
    } else {
      alert("Error deleting balance.");
    }
  });
}
</script>

{% endblock %}
