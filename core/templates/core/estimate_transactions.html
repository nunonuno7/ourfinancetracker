{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-calculator me-2"></i>
                    Transaction Estimation
                </h2>
                <div class="d-flex gap-2 align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <label for="year-filter" class="form-label mb-0">Year:</label>
                        <select id="year-filter" class="form-select form-select-sm" style="width: auto;">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <button id="refresh-summaries-btn" class="btn btn-outline-primary">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <a href="{% url 'transaction_list_v2' %}" class="btn btn-secondary">
                        <i class="fas fa-list"></i> Back to Transactions
                    </a>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle me-2"></i>How Transaction Estimation Works</h5>
                <p class="mb-1">
                    The system automatically calculates missing transactions based on your account balance changes and recorded income/investments.
                </p>
                <p class="mb-0">
                    <strong>Green status:</strong> All reconciled | 
                    <strong>Yellow status:</strong> Missing transactions detected
                </p>
            </div>

            <!-- Loading State -->
            <div id="loading-estimation" class="text-center py-5 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading estimation data...</p>
                <small class="text-muted">This may take a few seconds...</small>
            </div>

            <!-- Estimation Summary Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Monthly Reconciliation Status
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Period</th>
                                    <th>Status</th>
                                    <th>Estimated Type</th>
                                    <th class="text-end">Estimated Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="estimation-summaries-tbody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Details Modal -->
            <div class="modal fade" id="estimationDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h5 class="modal-title">
                                <i class="fas fa-calculator me-2 text-primary"></i>
                                Financial Estimation Details
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Period Info Header -->
                            <div class="alert alert-info mb-4">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    <div>
                                        <strong>Period: <span id="modal-period-title">Loading...</span></strong>
                                        <p class="mb-0 small">
                                            This analysis compares recorded transactions with account balance changes to identify missing entries.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Left Column: Transaction Data -->
                                <div class="col-lg-8">
                                    <div class="card mb-3">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-list-alt me-2"></i>
                                                Transaction Summary
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <!-- Estimated Transactions -->
                                                <div class="col-md-6">
                                                    <h6 class="text-warning">
                                                        <i class="fas fa-robot me-1"></i>
                                                        System Estimates
                                                    </h6>
                                                    <table class="table table-sm">
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    <i class="fas fa-arrow-up text-warning me-1"></i>
                                                                    Income:
                                                                </td>
                                                                <td class="text-end fw-bold text-warning" id="detail-estimated-income">0,00&nbsp;€</td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    <i class="fas fa-arrow-down text-warning me-1"></i>
                                                                    Expenses:
                                                                </td>
                                                                <td class="text-end fw-bold text-warning" id="detail-estimated-expenses-tx">0,00&nbsp;€</td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    <i class="fas fa-chart-line text-warning me-1"></i>
                                                                    Investments:
                                                                </td>
                                                                <td class="text-end fw-bold text-warning" id="detail-estimated-investments">+0,00&nbsp;€</td>
                                                            </tr>
                                                            <tr class="table-light border-top">
                                                                <td>
                                                                    <strong>
                                                                        <i class="fas fa-calculator text-warning me-1"></i>
                                                                        Total:
                                                                    </strong>
                                                                </td>
                                                                <td class="text-end">
                                                                    <strong class="text-warning" id="detail-estimated-total">+0,00&nbsp;€</strong>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>

                                                <!-- Combined Totals -->
                                                <div class="col-md-6">
                                                    <h6 class="text-primary">
                                                        <i class="fas fa-calculator me-1"></i>
                                                        Combined Total
                                                    </h6>
                                                    <table class="table table-sm table-bordered">
                                                        <tbody>
                                                            <tr class="table-light">
                                                                <td>
                                                                    <strong>
                                                                        <i class="fas fa-arrow-up text-success me-1"></i>
                                                                        Income:
                                                                    </strong>
                                                                </td>
                                                                <td class="text-end">
                                                                    <strong class="text-success" id="detail-income-inserted">0,00&nbsp;€</strong>
                                                                </td>
                                                            </tr>
                                                            <tr class="table-light">
                                                                <td>
                                                                    <strong>
                                                                        <i class="fas fa-arrow-down text-danger me-1"></i>
                                                                        Expenses:
                                                                    </strong>
                                                                </td>
                                                                <td class="text-end">
                                                                    <strong class="text-danger" id="detail-expense-inserted">0,00&nbsp;€</strong>
                                                                </td>
                                                            </tr>
                                                            <tr class="table-light">
                                                                <td>
                                                                    <strong>
                                                                        <i class="fas fa-chart-line text-info me-1"></i>
                                                                        Investments:
                                                                    </strong>
                                                                </td>
                                                                <td class="text-end">
                                                                    <strong class="text-info" id="detail-investment-inserted">+0,00&nbsp;€</strong>
                                                                </td>
                                                            </tr>
                                                            <tr class="table-primary border-top">
                                                                <td>
                                                                    <strong>
                                                                        <i class="fas fa-equals text-primary me-1"></i>
                                                                        Net Total:
                                                                    </strong>
                                                                </td>
                                                                <td class="text-end">
                                                                    <strong class="text-primary fs-6" id="detail-combined-total">+0,00&nbsp;€</strong>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column: Balance Analysis -->
                                <div class="col-lg-4">
                                    <div class="card mb-3">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-piggy-bank me-2"></i>
                                                Savings Analysis
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <tbody>
                                                    <tr>
                                                        <td>
                                                            <i class="fas fa-calendar-day me-1 text-muted"></i>
                                                            Current Month:
                                                        </td>
                                                        <td class="text-end fw-bold" id="detail-savings-current">0,00&nbsp;€</td>
                                                    </tr>
                                                    <tr>
                                                        <td>
                                                            <i class="fas fa-calendar-plus me-1 text-muted"></i>
                                                            Next Month:
                                                        </td>
                                                        <td class="text-end fw-bold" id="detail-savings-next">0,00&nbsp;€</td>
                                                    </tr>
                                                    <tr class="table-light">
                                                        <td>
                                                            <strong>
                                                                <i class="fas fa-exchange-alt me-1 text-primary"></i>
                                                                Change:
                                                            </strong>
                                                        </td>
                                                        <td class="text-end">
                                                            <strong id="detail-savings-diff" class="badge bg-primary">0,00&nbsp;€</strong>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>

                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Savings change indicates money flow between periods
                                            </small>
                                        </div>
                                    </div>

                                    <!-- Estimation Formula -->
                                    <div class="card">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="fas fa-formula me-2"></i>
                                                Estimation Formula
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="bg-light p-3 rounded mb-2">
                                                <small class="text-muted d-block mb-1">Expected Expenses:</small>
                                                <code>Income - Savings Change - Investments</code>
                                            </div>

                                            <table class="table table-sm mb-0">
                                                <tbody>
                                                    <tr>
                                                        <td>Expected Expenses:</td>
                                                        <td class="text-end fw-bold" id="detail-estimated-expenses">0,00&nbsp;€</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-danger">Missing Expenses:</td>
                                                        <td class="text-end fw-bold text-danger" id="detail-missing-expenses">0,00&nbsp;€</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-success">Missing Income:</td>
                                                        <td class="text-end fw-bold text-success" id="detail-missing-income">0,00&nbsp;€</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bottom Summary -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-secondary mb-0">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-lightbulb me-2 text-warning"></i>
                                            <div>
                                                <strong>How it works:</strong>
                                                <p class="mb-0 small">
                                                    The system compares your recorded transactions with account balance changes. 
                                                    If the math doesn't add up, it suggests creating an estimated transaction to balance the books.
                                                    This helps identify potentially missing income or expenses.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Ensure jQuery is loaded and pass CSRF token to the EstimationManager
    window.csrfToken = '{{ csrf_token }}';
</script>
<script src="{% static 'js/estimate_transactions.js' %}" defer></script>
{% endblock %}