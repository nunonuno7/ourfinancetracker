{% extends "base.html" %}
{% load static %}
{% load filtros %}

{% block content %}
<div class="container mt-4">
  <!-- ✅ Título e botão de nova transação -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Transactions</h2>
    <a href="{% url 'transaction_create' %}" class="btn btn-success">➕ New Transaction</a>
  </div>

  <!-- 📝 Toggle edição em massa -->
  <div class="d-flex align-items-center gap-3 mb-3">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="toggle-edit-mode">
      <label class="form-check-label" for="toggle-edit-mode">
        📝 Enable inline editing for all rows
      </label>
    </div>
    <div id="edit-actions" class="d-none">
      <button class="btn btn-sm btn-success">💾 Save All</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">✖ Cancel</button>
    </div>
  </div>

  {% if transactions %}
  <div class="table-responsive">
    <table id="transaction-table" class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Period</th>
          <th>Date</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Category</th>
          <th>Tags</th>
          <th>Account</th>
          <th class="text-center" style="width: 140px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for transaction in transactions %}
        <tr>
          <td data-field="period" data-raw="{{ transaction.period.year }}-{{ transaction.period.month|add:"0"|slice:"-2" }}">
            {{ transaction.period|date:"F Y"|capfirst }}
          </td>
          <td data-field="date">{{ transaction.date|date:"Y-m-d" }}</td>
          <td data-field="type">{{ transaction.get_type_display }}</td>
          <td data-field="amount">
            {{ transaction.amount|floatformat:2 }}{% if transaction.account.currency.symbol %}&nbsp;{{ transaction.account.currency.symbol }}{% endif %}
          </td>
          <td data-field="category">{{ transaction.category.name|default:"–" }}</td>
          <td data-field="tags">
            {% for tag in transaction.tags.all %}
              <span class="badge bg-secondary">{{ tag.name }}</span>
            {% empty %}
              <span class="text-muted">–</span>
            {% endfor %}
          </td>
          <td data-field="account">{{ transaction.account }}</td>
          <td class="text-center">
            <div class="d-flex flex-wrap gap-2 justify-content-center">
              <a href="{% url 'transaction_update' transaction.pk %}" class="btn btn-sm btn-outline-primary" title="Edit">✏️</a>
              <form method="post" action="{% url 'transaction_delete' transaction.pk %}" class="delete-form d-inline" data-name="transaction on {{ transaction.date|date:'F j, Y' }}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">🗑</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}

        <!-- 🔽 Linha inline para nova transação (sem <form>) -->
        <tr id="new-transaction-row" class="d-none">
          <td><input type="text" name="period_display" class="form-control" readonly></td>
          <td><input type="date" name="date" class="form-control" required></td>
          <td>
            <select name="type" class="form-control" required>
              <option value="IN">Income</option>
              <option value="EX">Expense</option>
              <option value="IV">Investment</option>
            </select>
          </td>
          <td><input type="number" name="amount" step="0.01" class="form-control" required></td>
          <td><input type="text" name="category" id="inline-category" class="form-control"></td>
          <td><input type="text" name="tags_input" id="inline-tags" class="form-control" placeholder="e.g. groceries, food"></td>
          <td>
            <select name="account" class="form-control">
              {% for acc in request.user.accounts.all %}
                <option value="{{ acc.id }}">{{ acc.name }}</option>
              {% endfor %}
            </select>
          </td>
          <td class="text-center d-flex gap-2">
            <button type="button" class="btn btn-sm btn-success" id="submit-inline">💾</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="cancel-inline">✖</button>
          </td>
          <input type="hidden" name="period" id="inline-period" />
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Botão "+" -->
  <div class="d-flex justify-content-center mt-3">
    <button id="show-inline-form" class="btn btn-outline-primary rounded-circle"
            style="width: 3rem; height: 3rem; font-size: 1.5rem;">+</button>
  </div>

  {% else %}
    <div class="alert alert-info">No transactions found.</div>
  {% endif %}
</div>

<!-- Scripts -->
<script src="{% static 'js/transaction_list.js' %}"></script>
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
{% endblock %}