{% extends "base.html" %}
{% load static %}
{% load filtros %}
{% now "Y-m-d" as today %}

{% block content %}
<div class="container mt-4">

  <!-- ðŸ†• ADICIONADO â€” token CSRF global para o fetch() -->
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  <!-- CabeÃ§alho -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Transactions</h2>
    <div class="d-flex gap-2">
      <a href="{% url 'transaction_export_xlsx' %}" class="btn btn-outline-primary">â¬‡ Exportar Excel</a>
      <a href="{% url 'transaction_import_xlsx' %}" class="btn btn-outline-success">â¬† Importar Excel</a>
      <a href="#" class="btn btn-outline-secondary" id="clear-cache-btn" title="Limpar cache">
        ðŸ§¹ Limpar cache
      </a>

      <a href="{% url 'transaction_create' %}" class="btn btn-success">âž• New Transaction</a>
    </div>
  </div>

  <!-- Filtros por datas -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <label for="start-date" class="form-label" id="start-label">Start Date</label>
      <input type="text" id="start-date" name="start-date" class="form-control"
             value="2025-01-01" aria-labelledby="start-label">
    </div>
    <div class="col-md-3">
      <label for="end-date" class="form-label" id="end-label">End Date</label>
      <input type="text" id="end-date" name="end-date" class="form-control"
             value="{{ today }}" aria-labelledby="end-label">
    </div>
  </div>

  <!-- Filtros adicionais -->
  <div class="row g-3 mb-3">
    <div class="col-md-3 col-sm-6">
      <label for="filter-type" class="form-label">Type</label>
      <select id="filter-type" name="filter-type" class="form-select">
        <option value="">All Types</option>
        <option value="Expense">Expense</option>
        <option value="Income">Income</option>
        <option value="Investment">Investment</option>
        <option value="Transfer">Transfer</option>
      </select>
    </div>

    <div class="col-md-3 col-sm-6">
      <label for="filter-account" class="form-label">Account</label>
      <select id="filter-account" name="filter-account" class="form-select">
        <option value="">All Accounts</option>
        {% for acc in request.user.accounts.all %}
          <option value="{{ acc.name }}">{{ acc.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3 col-sm-6">
      <label for="filter-category" class="form-label">Category</label>
      <select id="filter-category" name="filter-category" class="form-select">
        <option value="">All Categories</option>
      </select>
    </div>

    <div class="col-md-3 col-sm-6">
      <label for="filter-period" class="form-label">Period</label>
      <select id="filter-period" name="filter-period" class="form-select">
        <option value="">All Periods</option>
        {% for p in period_options %}
          <option value="{{ p }}" {% if p == current_period %}selected{% endif %}>
            {{ p }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Filtros avanÃ§ados -->
  <div class="row g-3 mb-3">
    <div class="col-md-3 col-sm-6">
      <label for="filter-amount-min" class="form-label">Min Amount</label>
      <input type="number" id="filter-amount-min" class="form-control" 
             placeholder="0.00" step="0.01" min="0">
    </div>

    <div class="col-md-3 col-sm-6">
      <label for="filter-amount-max" class="form-label">Max Amount</label>
      <input type="number" id="filter-amount-max" class="form-control" 
             placeholder="999999.99" step="0.01" min="0">
    </div>

    <div class="col-md-3 col-sm-6">
      <label for="filter-tags" class="form-label">Tags</label>
      <input type="text" id="filter-tags" class="form-control" 
             placeholder="tag1, tag2..." data-bs-toggle="tooltip" 
             title="Separate multiple tags with commas">
    </div>
  </div>

  <!-- BotÃµes de aÃ§Ã£o -->
  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <button id="clear-filters" class="btn btn-outline-danger">
      <i class="fas fa-times-circle"></i> Clear Filters
    </button>

    <div class="btn-group" role="group">
      <input type="checkbox" class="btn-check" id="bulk-select-mode" autocomplete="off">
      <label class="btn btn-outline-primary" for="bulk-select-mode">
        <i class="fas fa-check-square"></i> Bulk Select
      </label>
    </div>

    <div id="bulk-actions" class="btn-group d-none" role="group">
      <button type="button" class="btn btn-outline-success" id="bulk-mark-cleared">
        <i class="fas fa-check"></i> Mark Cleared
      </button>
      <button type="button" class="btn btn-outline-warning" id="bulk-duplicate">
        <i class="fas fa-copy"></i> Duplicate
      </button>
      <button type="button" class="btn btn-outline-danger" id="bulk-delete">
        <i class="fas fa-trash"></i> Delete Selected
      </button>
    </div>

    <div class="ms-auto">
      <small class="text-muted" id="results-count">Loading...</small>
    </div>
  </div>

  <!-- Tabela -->
  <div class="table-responsive">
    <table id="transaction-table" class="table table-bordered table-hover align-middle" style="width: 100%">
      <thead class="table-light">
        <tr>
          <th style="width: 40px;">
            <input type="checkbox" class="form-check-input" id="select-all" style="display: none;">
          </th>
          <th class="d-none d-md-table-cell">Period</th>
          <th>Date</th>
          <th>Type</th>
          <th>Amount</th>
          <th class="d-none d-lg-table-cell">Category</th>
          <th class="d-none d-xl-table-cell">Tags</th>
          <th class="d-none d-md-table-cell">Account</th>
          <th class="text-center" style="width: 100px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- AJAX -->
      </tbody>
    </table>
  </div>

  <!-- Modal para visualizaÃ§Ã£o completa em mobile -->
  <div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Transaction Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="transaction-details">
          <!-- Populated by JavaScript -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a href="#" class="btn btn-primary" id="modal-edit-btn">Edit</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CSRF tambÃ©m disponÃ­vel em JS -->
<script>window.CSRF_TOKEN = '{{ csrf_token }}';</script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

<!-- DataTables -->
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Custom CSS for improved UX -->
<style>
@media (max-width: 768px) {
  .table-responsive {
    font-size: 0.9rem;
  }

  .btn-group .btn {
    padding: 0.25rem 0.5rem;
  }

  .badge {
    font-size: 0.7rem;
  }
}

.table td {
  vertical-align: middle;
}

.row-select {
  cursor: pointer;
}

#bulk-actions {
  transition: all 0.3s ease;
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 123, 255, 0.1);
}

.transaction-amount {
  font-family: 'Courier New', monospace;
}
</style>

<!-- Scripts do projeto -->
<script src="{% static 'js/transaction_list_ajax.js' %}"></script>
<script src="{% static 'js/main.js' %}"></script>

<!-- Initialize tooltips -->
<script>
$(document).ready(function() {
  $('[data-bs-toggle="tooltip"]').tooltip();
});
</script>

<script>
// ðŸ”„ Verificar se houve mudanÃ§as e recarregar se necessÃ¡rio
$(document).ready(function() {
  // Verificar se hÃ¡ flag de mudanÃ§a na sessÃ£o
  {% if request.session.transaction_changed %}
    console.log('ðŸ”„ TransaÃ§Ã£o foi alterada, recarregando lista...');
    if (window.transactionTable) {
      // Usar setTimeout para garantir que a tabela estÃ¡ inicializada
      setTimeout(() => {
        window.transactionTable.ajax.reload(null, false);
      }, 500);
    }

    // Limpar flag da sessÃ£o via AJAX
    fetch('/transactions/clear-session-flag/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
    });
  {% endif %}
});
</script>

{% endblock %}