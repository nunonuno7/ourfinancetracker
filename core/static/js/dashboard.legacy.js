(()=>{var He=Object.defineProperty,Ge=Object.defineProperties;var qe=Object.getOwnPropertyDescriptors;var we=Object.getOwnPropertySymbols;var Ve=Object.prototype.hasOwnProperty,Xe=Object.prototype.propertyIsEnumerable;var Ce=(x,b,d)=>b in x?He(x,b,{enumerable:!0,configurable:!0,writable:!0,value:d}):x[b]=d,z=(x,b)=>{for(var d in b||(b={}))Ve.call(b,d)&&Ce(x,d,b[d]);if(we)for(var d of we(b))Xe.call(b,d)&&Ce(x,d,b[d]);return x},Ie=(x,b)=>Ge(x,qe(b));var Ze=(x,b)=>()=>(x&&(b=x(x=0)),b);var Qe=(x,b)=>()=>(b||x((b={exports:{}}).exports,b),b.exports);var S=(x,b,d)=>new Promise((E,w)=>{var I=k=>{try{D(d.next(k))}catch(T){w(T)}},f=k=>{try{D(d.throw(k))}catch(T){w(T)}},D=k=>k.done?E(k.value):Promise.resolve(k.value).then(I,f);D((d=d.apply(x,b)).next())});function et(x){let b=document.cookie?document.cookie.split("; "):[];for(let E=0;E<b.length;E++){let[w,...I]=b[E].split("=");if(w===x)return decodeURIComponent(I.join("="))}let d=document.querySelector('meta[name="csrf-token"]');return d?d.getAttribute("content"):null}function V(w){return S(this,arguments,function*(x,{method:b="GET",headers:d={},body:E}={}){let I={method:b,credentials:"same-origin",headers:z({"X-Requested-With":"XMLHttpRequest"},d)};if(b!=="GET"&&b!=="HEAD"){let k=et("csrftoken");k&&(I.headers["X-CSRFToken"]=k),E&&!(E instanceof FormData)?(I.headers["Content-Type"]="application/json",I.body=JSON.stringify(E)):I.body=E!=null?E:null}else E&&!(E instanceof FormData)?(I.headers["Content-Type"]="application/json",I.body=JSON.stringify(E)):E&&(I.body=E);let f=yield fetch(x,I);if(!f.ok){let k=yield f.text().catch(()=>"");throw new Error(`HTTP ${f.status} on ${x} :: ${k.slice(0,300)}`)}return(f.headers.get("Content-Type")||"").includes("application/json")?f.json():f.text()})}var Se=Ze(()=>{});var tt=Qe(F=>{Se();document.addEventListener("DOMContentLoaded",()=>{var fe,he,be,ye,ve,xe;let x=[],b=[],d=[],E=[],w=[],I=[],f={},D={},k="evolution",T=0,X=!1,C=document.getElementById("year-range"),h=document.getElementById("period-range"),J=e=>{let[s,o]=e.split("/"),r={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};return new Date(2e3+parseInt(o),r[s])},B=e=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}).format(e),nt=e=>`${e>=0?"+":""}${e.toFixed(1)}%`,at=()=>{["receita-media","despesa-estimada","verified-expenses","valor-investido","patrimonio-total"].forEach(s=>{let o=document.getElementById(s);o&&(o.textContent="...",o.style.opacity="0.6")})},ot=e=>{if(e.length<2)return 0;let s=e.slice(-3).reduce((r,a)=>r+a,0)/Math.min(3,e.length),o=e.slice(0,-3).reduce((r,a)=>r+a,0)/Math.max(1,e.length-3);return o>0?(s-o)/o*100:0},ke=(e,s)=>{let o,r;return function(...t){r=t;let n=()=>{clearTimeout(o),o=null,e(...r)};o&&clearTimeout(o),o=setTimeout(n,s)}},Pe=()=>{let e=document.getElementById("evolution-chart").getContext("2d"),s=document.getElementById("allocation-chart").getContext("2d");f.evolution=new Chart(e,{type:"line",data:{labels:[],datasets:[{label:"Savings (\u20AC)",data:[],borderColor:"#28a745",backgroundColor:"rgba(40, 167, 69, 0.1)",tension:.4,fill:!0},{label:"Investments (\u20AC)",data:[],borderColor:"#007bff",backgroundColor:"rgba(0, 123, 255, 0.1)",tension:.4,fill:!0},{label:"Total Net Worth",data:[],borderColor:"#6f42c1",backgroundColor:"rgba(111, 66, 193, 0.1)",tension:.4,borderWidth:3,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,resizeDelay:0,plugins:{legend:{position:"top"},title:{display:!0,text:"Net Worth Evolution Over Time"},tooltip:{mode:"index",intersect:!1,backgroundColor:"rgba(0, 0, 0, 0.95)",titleColor:"#fff",bodyColor:"#fff",footerColor:"#a0a0a0",borderColor:"rgba(255, 255, 255, 0.3)",borderWidth:2,cornerRadius:12,titleFont:{size:14,weight:"bold"},bodyFont:{size:13},footerFont:{size:11},padding:12,displayColors:!0,callbacks:{title:function(t){var n;return(n=t[0])!=null&&n.label?`\u{1F4C5} Period: ${t[0].label}`:""},label:function(t){let n=t.parsed.y||0;return`${t.dataset.label.includes("Savings")?"\u{1F4B0}":t.dataset.label.includes("Investment")?"\u{1F4C8}":"\u{1F48E}"} ${t.dataset.label}: ${B(n)}`},afterBody:function(t){return[]}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(t){return B(t)}},grid:{color:"rgba(0, 0, 0, 0.1)"}},x:{grid:{color:"rgba(0, 0, 0, 0.1)"}}},interaction:{intersect:!0,mode:"point"},elements:{point:{radius:4,hoverRadius:8}}}}),f.allocation=new Chart(s,{type:"doughnut",data:{labels:["Savings (\u20AC)","Investments (\u20AC)"],datasets:[{data:[],backgroundColor:["#28a745","#007bff","#ffc107","#dc3545"],borderWidth:3,borderColor:"#fff",hoverBorderWidth:5}]},options:{responsive:!0,maintainAspectRatio:!1,resizeDelay:0,plugins:{legend:{position:"bottom"},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.95)",titleColor:"#fff",bodyColor:"#fff",footerColor:"#a0a0a0",borderColor:"rgba(255, 255, 255, 0.3)",borderWidth:2,cornerRadius:12,titleFont:{size:14,weight:"bold"},bodyFont:{size:13},footerFont:{size:11},padding:12,callbacks:{title:function(t){return"\u{1F4BC} Portfolio Breakdown"},label:function(t){let n=t.label||"",l=t.parsed,c=t.dataset.data.reduce((p,m)=>p+m,0),i=(l/c*100).toFixed(1);return`${n.includes("Savings")?"\u{1F4B0}":"\u{1F4C8}"} ${n}: ${B(l)} (${i}%)`},afterLabel:function(t){return[]},footer:function(t){return[]}}}},cutout:"60%"}});let o=document.createElement("canvas");o.id="flows-chart",o.style.display="none",document.getElementById("evolution-chart").parentNode.appendChild(o),f.flows=new Chart(o.getContext("2d"),{type:"bar",data:{labels:[],datasets:[{label:"Income (\u20AC)",data:[],backgroundColor:"rgba(40, 167, 69, 0.8)",borderColor:"#28a745",borderWidth:1},{label:"Estimated Expenses (\u20AC)",data:[],backgroundColor:"rgba(220, 53, 69, 0.8)",borderColor:"#dc3545",borderWidth:1},{label:"Investments (\u20AC)",data:[],backgroundColor:"rgba(0, 123, 255, 0.8)",borderColor:"#007bff",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,resizeDelay:0,plugins:{title:{display:!0,text:"Monthly Financial Flows"},tooltip:{mode:"point",intersect:!0,backgroundColor:"rgba(0, 0, 0, 0.9)",titleColor:"#fff",bodyColor:"#fff",footerColor:"#a0a0a0",borderColor:"rgba(255, 255, 255, 0.2)",borderWidth:1,cornerRadius:8,callbacks:{title:function(t){var n;return(n=t[0])!=null&&n.label?`\u{1F4C5} Financial Flow: ${t[0].label}`:""},label:function(t){let n=t.parsed.y||0;return`${t.dataset.label.includes("Income")?"\u{1F4B0}":t.dataset.label.includes("Expenses")?"\u{1F4B8}":"\u{1F4C8}"} ${t.dataset.label}: ${B(Math.abs(n))}`},afterBody:function(t){return[]}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(t){return B(t)}}}}}});let r=document.getElementById("returns-chart");r.style.display="none",f.returns=new Chart(r.getContext("2d"),{type:"line",data:{labels:[],datasets:[{label:"Portfolio Return (%)",data:[],borderColor:"#6f42c1",borderWidth:2,tension:.3,fill:!1},{label:"Average Portfolio Return (%)",data:[],borderColor:"#28a745",borderWidth:2,borderDash:[6,6],pointRadius:2,tension:.3,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,resizeDelay:0,plugins:{title:{display:!0,text:"Investment Returns Over Time"},tooltip:{mode:"point",intersect:!0,backgroundColor:"rgba(0, 0, 0, 0.9)",titleColor:"#fff",bodyColor:"#fff",footerColor:"#a0a0a0",borderColor:"rgba(255, 255, 255, 0.2)",borderWidth:1,cornerRadius:8,callbacks:{title:function(t){var n;return(n=t[0])!=null&&n.label?`\u{1F4C5} ${t[0].label}`:""},label:function(t){let n=t.parsed.y;if(n==null||isNaN(n))return`${t.dataset.label}: N/A`;let l=`${n>=0?"+":""}${n.toFixed(2)}%`;return`${t.dataset.label}: ${l}`},afterBody:function(t){return[]}}}},scales:{y:{ticks:{callback:function(t){return t==null||isNaN(t)?"0%":t.toFixed(1)+"%"}},title:{display:!0,text:"Return (%)"}}}}});let a=document.createElement("canvas");a.id="expenses-chart",a.style.display="none",document.getElementById("evolution-chart").parentNode.appendChild(a),f.expenses=new Chart(a.getContext("2d"),{type:"doughnut",data:{labels:[],datasets:[{data:[],backgroundColor:["#dc3545","#fd7e14","#ffc107","#28a745","#20c997","#17a2b8","#6f42c1","#e83e8c"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,resizeDelay:0,plugins:{title:{display:!0,text:"Spending by Category"},legend:{position:"right"},tooltip:{callbacks:{label:function(t){let n=t.parsed,l=t.dataset.data.reduce((i,u)=>i+u,0),c=(n/l*100).toFixed(1);return`${t.label}: ${B(n)} (${c}%)`},footer:function(t){return[]}}}}}})},Z=!1,K=!1,le=null,M=null,Q=0,N=new Map,Fe=12e4,Me=6e4,ee=(e=!0)=>S(F,null,function*(){var s,o;if(console.log("\u{1F4CA} [loadAccountBalances] Starting load, useCache:",e),e&&M&&Date.now()-Q<Fe)return console.log("\u{1F680} [loadAccountBalances] Using cached balance data"),x=M.columns||[],b=M.rows||[],d=x.slice(2).sort((a,t)=>J(a)-J(t)),w=[...new Set(d.map(a=>2e3+parseInt(a.split("/")[1])))].sort((a,t)=>a-t),E=d,console.log("\u{1F4CB} [loadAccountBalances] Cache data restored:",{periods:d.length,years:w.length,rows:b.length}),M;if(K)return console.log("\u{1F504} [loadAccountBalances] Already loading, waiting..."),new Promise(r=>{let a=setInterval(()=>{!K&&M&&(clearInterval(a),r(M))},100)});K=!0;try{console.log("\u{1F310} [loadAccountBalances] Fetching from API...");let r=yield fetch("/account-balances/json/");if(!r.ok){console.warn("\u26A0\uFE0F [loadAccountBalances] API response not OK:",r.status);let i=W();return yield j(i),i}let a=yield r.json();if(console.log("\u2705 [loadAccountBalances] API data received:",{hasColumns:!!a.columns,hasRows:!!a.rows,columnsLength:((s=a.columns)==null?void 0:s.length)||0,rowsLength:((o=a.rows)==null?void 0:o.length)||0}),x=a.columns||[],b=a.rows||[],x.length===0||b.length===0){console.warn("\u26A0\uFE0F [loadAccountBalances] Empty data received, using mock data");let i=W();return yield j(i),i}if(x=a.columns||[],b=a.rows||[],x.length===0||b.length===0){console.warn("\u26A0\uFE0F [loadAccountBalances] Empty data received, using mock data");let i=W();return yield j(i),i}let t=x.slice(2);console.log("\u{1F4C5} [loadAccountBalances] Processing periods:",t),b.forEach(i=>{t.forEach(u=>{i[u]!==null&&i[u]!==void 0&&(i[u]=parseFloat(i[u]))})}),d=t.sort((i,u)=>J(i)-J(u)),w=[...new Set(d.map(i=>2e3+parseInt(i.split("/")[1])))].sort((i,u)=>i-u);let n=w[0]||new Date().getFullYear(),l=w[w.length-1]||new Date().getFullYear();I=[n,l],E=d,console.log("\u{1F4CA} [loadAccountBalances] Data processed:",{allPeriods:d.length,allYears:w.length,yearRange:I}),M=Ie(z({},a),{columns:x,rows:b,allPeriods:d,allYears:w,fullPeriods:E}),Q=Date.now(),yield j(M);let c=document.getElementById("last-update");return c&&(c.textContent=new Date().toLocaleString("en-GB")),console.log("\u2705 [loadAccountBalances] Complete success"),M}catch(r){console.error("\u274C [loadAccountBalances] Error loading balances:",r);let a=W();return yield j(a),a}finally{K=!1}}),j=e=>S(F,null,function*(){console.log("\u{1F39B}\uFE0F [initializeSlidersWithData] Initializing sliders...");try{if(C!=null&&C.noUiSlider)console.log("\u2139\uFE0F [initializeSlidersWithData] Sliders already initialized");else if(w&&w.length>0)console.log("\u{1F4C5} [initializeSlidersWithData] Initializing year slider with years:",w),de(w),console.log("\u{1F4C5} [initializeSlidersWithData] Initializing period slider with periods:",(E==null?void 0:E.length)||0),se(E||[],!0,12),Ye();else{console.warn("\u26A0\uFE0F [initializeSlidersWithData] No years available, using current year");let s=new Date().getFullYear();de([s,s]);let o=new Date().getMonth(),a=`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][o]}/${s.toString().slice(-2)}`;se([a],!0,1)}}catch(s){console.error("\u274C [initializeSlidersWithData] Error initializing sliders:",s);let o=C==null?void 0:C.parentElement,r=h==null?void 0:h.parentElement;o&&(o.innerHTML=`
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Year slider initialization failed.
            <button class="btn btn-sm btn-outline-primary ms-2" onclick="location.reload()">
              Refresh Page
            </button>
          </div>
        `),r&&(r.innerHTML=`
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Period slider initialization failed.
            <button class="btn btn-sm btn-outline-primary ms-2" onclick="location.reload()">
              Refresh Page
            </button>
          </div>
        `)}}),W=()=>{let e=new Date().getFullYear(),s=new Date().getMonth()+1,o=["type","currency"],r=[];for(let t=5;t>=0;t--){let n=e,l=s-t;l<=0&&(n--,l+=12);let c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];r.push(`${c[l-1]}/${n.toString().slice(-2)}`)}o.push(...r);let a=[z({type:"Savings",currency:"EUR"},Object.fromEntries(r.map((t,n)=>[t,1e3+n*200]))),z({type:"Investment",currency:"EUR"},Object.fromEntries(r.map((t,n)=>[t,5e3+n*500])))];return{columns:o,rows:a}},H=(e=null,s=null)=>S(F,null,function*(){let o=`${e||"null"}-${s||"null"}`,r=o,a=N.get(r);if(a&&Date.now()-a.timestamp<Me)return console.log("\u{1F680} Using cached KPI data for instant display"),O(a.data),a.data;if(M&&!a){let t=$e();O(t),console.log("\u26A1 Showing approximate KPIs while loading exact data")}if(Z)return console.log("\u{1F504} KPI loading already in progress, skipping"),(a==null?void 0:a.data)||{};if(o===le&&Date.now()-T<2e3)return console.log("\u{1F504} Ignorando chamada duplicada de KPIs:",o),(a==null?void 0:a.data)||{};Z=!0,le=o,T=Date.now();try{let t="/dashboard/kpis/";if(e&&s){let c=p=>{let[m,g]=p.split("/");return`20${g}-${{Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"}[m]}`},i=c(e),u=c(s);t+=`?start_period=${i}&end_period=${u}`}console.log("\u{1F4CA} Carregando KPIs:",t);let n=yield fetch(t);if(!n.ok){console.warn("\u26A0\uFE0F KPIs endpoint not available, using mock data");let c=R();return O(c),c}let l=yield n.json();if(console.log("\u{1F4CA} KPIs carregados"),N.set(r,{data:l,timestamp:Date.now()}),N.size>20){let c=N.keys().next().value;N.delete(c)}return O(l),l}catch(t){console.error("\u274C Erro ao carregar KPIs:",t);let n=R();return O(n),n}finally{Z=!1}}),$e=()=>{if(!M||!M.rows)return R();try{let e=d[d.length-1],s=d[d.length-2]||e,o=0,r=0,a=0,t=0;M.rows.forEach(m=>{let g=parseFloat(m[e])||0,y=parseFloat(m[s])||0,v=(m.type||"").toLowerCase();v.includes("savings")||v.includes("current")?(o+=g,a+=y):v.includes("investment")&&(r+=g,t+=y)});let n=o+r,l=a+t,c=l>0?(n-l)/l*100:0,i=Math.max(o-a+r-t+200,0),u=Math.max(200,i*.3),p=i>0?(i-u)/i*100:0;return{patrimonio_total:`${n.toLocaleString("en-GB")} \u20AC`,receita_media:`${Math.round(i).toLocaleString("en-GB")} \u20AC`,despesa_estimada_media:`${Math.round(u).toLocaleString("en-GB")} \u20AC`,valor_investido_total:`${r.toLocaleString("en-GB")} \u20AC`,despesas_justificadas_pct:"95%",taxa_poupanca:`${p.toFixed(1)}%`,wealth_growth:`${c>=0?"+":""}${c.toFixed(1)}%`,investment_rate:n>0?`${(r/n*100).toFixed(1)}%`:"0%",status:"fast_estimate"}}catch(e){return console.warn("Failed to generate enhanced approximate KPIs:",e),R()}},R=()=>({patrimonio_total:"12,500 \u20AC",receita_media:"2,500 \u20AC",despesa_estimada_media:"1,800 \u20AC",valor_investido_total:"8,500 \u20AC",despesas_justificadas_pct:"85%",rentabilidade_mensal_media:"+2.5%",status:"mock_data"}),te=()=>S(F,null,function*(){try{let e=yield fetch("/financial-analysis/json/");if(!e.ok){console.warn("\u26A0\uFE0F Financial analysis endpoint unavailable, using simulated data");let o=ne();return D=o,q(o),G(o),o}let s=yield e.json();return console.log("\u{1F4C8} Financial analysis received:",s),D=s,q(s),G(s),s}catch(e){console.warn("\u26A0\uFE0F Error loading financial analysis, using simulated data:",e);let s=ne();return D=s,q(s),G(s),s}}),ne=()=>{let e={data:[],summary:{avg_return:-5.2,avg_income:2300,avg_expense:1900,volatility:15.3}};return d.slice(-12).forEach((s,o)=>{let r=2e3+Math.random()*600,a=1500+Math.random()*800;e.data.push({period:s.replace("/","-20"),income:r,expense_estimated:a,investment_flow:Math.max(0,r-a-200),portfolio_return:(Math.random()-.5)*20})}),e},_e=(e,s,o,r)=>{let a=[];e.forEach((n,l)=>{var m;let c=0,i=0;b.forEach(g=>{let y=parseFloat(g[n])||0,v=(g.type||"").toLowerCase();v.includes("savings")&&s?c+=y:v.includes("investment")&&o?i+=y:v.includes("current")&&r&&(c+=y)});let u=l>0&&((m=a[l-1])==null?void 0:m.portfolio_value)||i,p=u>0?(i-u)/u*100:0;a.push({period:n.replace("/","-20"),income:2e3+Math.random()*1e3,expense_estimated:1500+Math.random()*800,investment_flow:Math.max(0,i-u),portfolio_return:p,savings_balance:c,portfolio_value:i})});let t=a.length>0?a.reduce((n,l)=>n+l.portfolio_return,0)/a.length:0;return{data:a,summary:{avg_return:t,avg_income:a.length>0?a.reduce((n,l)=>n+l.income,0)/a.length:0,avg_expense:a.length>0?a.reduce((n,l)=>n+l.expense_estimated,0)/a.length:0,volatility:15.3}}},O=e=>{let s={"receita-media":e.receita_media||e.patrimonio_total||"0 \u20AC","despesa-estimada":e.despesa_estimada_media||e.receita_media||"0 \u20AC","verified-expenses":e.despesas_justificadas_pct_str||"0%","valor-investido":e.valor_investido_total||"0 \u20AC","patrimonio-total":e.patrimonio_total||"0 \u20AC"},o=parseFloat((e.receita_media||"0").replace(/[^\d.-]/g,""))||0,r=parseFloat((e.despesa_estimada_media||"0").replace(/[^\d.-]/g,""))||0,a=o>0?(o-r)/o*100:0;s["taxa-poupanca"]=`${a.toFixed(1)}%`,Object.entries(s).forEach(([n,l])=>{let c=document.getElementById(n);if(c){c.textContent=l,c.style.opacity="1";let i=De(n,l,e);c.setAttribute("data-bs-toggle","tooltip"),c.setAttribute("data-bs-placement","top"),c.setAttribute("data-bs-html","true"),c.setAttribute("title",i),c.offsetParent!==null&&(c.style.transform="scale(1.05)",c.style.transition="transform 0.2s ease",setTimeout(()=>{c.style.transform="scale(1)"},200))}else console.warn(`\u26A0\uFE0F KPI element not found: ${n}`)}),[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(n=>{let l=bootstrap.Tooltip.getInstance(n);l&&l.dispose(),new bootstrap.Tooltip(n)});try{Be(e)}catch(n){console.warn("\u26A0\uFE0F Error updating progress bars:",n)}},De=(e,s,o)=>{let r=parseFloat((o.receita_media||"0").replace(/[^\d.-]/g,""))||0,a=parseFloat((o.despesa_estimada_media||"0").replace(/[^\d.-]/g,""))||0,t=parseFloat((o.valor_investido_total||"0").replace(/[^\d.-]/g,""))||0,n=parseFloat((o.patrimonio_total||"0").replace(/[^\d.-]/g,""))||0;switch(e){case"receita-media":return`
          <div class="text-start">
            <strong>\u{1F4B0} Average Income</strong><br>
            Current: <span class="text-success">${s}</span><br>
            <small>\u{1F4CA} Monthly average across selected period</small><br>
            <small>\u{1F4A1} Tip: Higher income enables better investment opportunities</small>
          </div>
        `;case"despesa-estimada":let l=r>0?(a/r*100).toFixed(1):0;return`
          <div class="text-start">
            <strong>\u{1F4B8} Average Expenses</strong><br>
            Current: <span class="text-danger">${s}</span><br>
            <small>\u{1F4CA} ${l}% of income</small><br>
            <small>\u{1F4A1} ${l<70?"Excellent expense control!":"Consider reducing expenses"}</small>
          </div>
        `;case"taxa-poupanca":let c=parseFloat(s.replace("%",""));return`
          <div class="text-start">
            <strong>\u{1F4C8} Savings Rate</strong><br>
            Current: <span class="${c>=20?"text-success":c>=10?"text-warning":"text-danger"}">${s}</span><br>
            <small>\u{1F3AF} Target: 20% or higher</small><br>
            <small>\u{1F4A1} ${c>=20?"Outstanding!":c>=10?"Good progress":"Room for improvement"}</small>
          </div>
        `;case"valor-investido":let i=n>0?(t/n*100).toFixed(1):0;return`
          <div class="text-start">
            <strong>\u{1F4C8} Total Invested</strong><br>
            Amount: <span class="text-primary">${s}</span><br>
            <small>\u{1F4CA} ${i}% of net worth</small><br>
            <small>\u{1F4A1} ${i>60?"High growth focus":i>30?"Balanced approach":"Conservative strategy"}</small>
          </div>
        `;case"patrimonio-total":return`
          <div class="text-start">
            <strong>\u{1F48E} Total Net Worth</strong><br>
            Current: <span class="text-success fw-bold">${s}</span><br>
            <small>\u{1F4CA} All accounts combined</small><br>
            <small>\u{1F4A1} Your complete financial position</small>
          </div>
        `;default:return`<strong>${s}</strong><br><small>Financial metric</small>`}},Be=e=>{var i,u,p,m;let s=parseFloat(((i=e.receita_media)==null?void 0:i.replace(/[^\d.-]/g,""))||0),o=parseFloat(((u=e.despesa_estimada_media)==null?void 0:u.replace(/[^\d.-]/g,""))||0),r=parseFloat(((p=e.valor_investido_total)==null?void 0:p.replace(/[^\d.-]/g,""))||0),a=parseFloat(((m=e.patrimonio_total)==null?void 0:m.replace(/[^\d.-]/g,""))||0),t=s>0?(s-o)/s*100:0,n=parseFloat(e.despesas_justificadas_pct)||0,l={"receita-progress":Math.min(100,s/3e3*100),"despesa-progress":Math.min(100,o/2500*100),"verified-progress":Math.min(100,n),"investido-progress":Math.min(100,r/2e4*100),"patrimonio-progress":Math.min(100,a/25e3*100),"poupanca-progress":Math.min(100,t*2)};Object.entries(l).forEach(([g,y])=>{let v=document.getElementById(g);v&&(v.style.width=`${y}%`,v.style.transition="width 0.5s ease")});let c={"receita-change":"+5.2% vs previous month","despesa-change":"-2.1% vs previous month","verified-change":n>=90?"\u2705 Mostly verified":n>=75?"\u{1F44D} Low estimation":n>=50?"\u2139\uFE0F Moderate verification":"\u26A0\uFE0F Many estimated expenses","investido-change":"+12.5% this year","patrimonio-change":"+8.7% vs previous month","poupanca-change":t>=20?"\u{1F3AF} Excellent":"\u26A0\uFE0F Can improve"};Object.entries(c).forEach(([g,y])=>{let v=document.getElementById(g);v&&(v.textContent=y,v.style.fontSize="0.75rem")})},Ae=()=>S(F,null,function*(){if(!(!f.evolution||!h||!h.noUiSlider))return new Promise(e=>{requestAnimationFrame(()=>S(F,null,function*(){var s,o,r,a,t,n;try{let[l,c]=h.noUiSlider.get(),i=d.indexOf(l),u=d.indexOf(c),p=d.slice(i,u+1),m=(o=(s=document.getElementById("include-savings"))==null?void 0:s.checked)!=null?o:!0,g=(a=(r=document.getElementById("include-investments"))==null?void 0:r.checked)!=null?a:!0,y=(n=(t=document.getElementById("include-current"))==null?void 0:t.checked)!=null?n:!0,v=p.map(P=>{let A=0,U=0;return b.forEach(Ee=>{let re=parseFloat(Ee[P])||0,ie=(Ee.type||"").toLowerCase();ie.includes("savings")&&m?A+=re:ie.includes("investment")&&g?U+=re:ie.includes("current")&&y&&(A+=re)}),{period:P,savings:A,investments:U,total:A+U}}),_=v.map(P=>P.savings),L=v.map(P=>P.investments),Ke=v.map(P=>P.total);if(k==="evolution"){let P=[];m&&P.push({label:"Savings (\u20AC)",data:_,borderColor:"#28a745",backgroundColor:"rgba(40, 167, 69, 0.1)",tension:.4,fill:!0}),g&&P.push({label:"Investments (\u20AC)",data:L,borderColor:"#007bff",backgroundColor:"rgba(0, 123, 255, 0.1)",tension:.4,fill:!0}),P.push({label:"Total Net Worth",data:Ke,borderColor:"#6f42c1",backgroundColor:"rgba(111, 66, 193, 0.1)",tension:.4,borderWidth:3,fill:!1}),f.evolution.data.labels=p,f.evolution.data.datasets=P,f.evolution.update("none")}else k==="flows"?yield G(D):k==="returns"?yield Te():k==="expenses"&&Ne();if(v.length>0){let P=v[v.length-1],A=[],U=[];m&&P.savings>0&&(A.push(P.savings),U.push("Savings (\u20AC)")),g&&P.investments>0&&(A.push(P.investments),U.push("Investments (\u20AC)")),f.allocation.data.labels=U,f.allocation.data.datasets[0].data=A,f.allocation.update("none")}e()}catch(l){console.error("\u274C Error updating charts:",l),e()}}))})}),G=e=>S(F,null,function*(){if(f.flows){try{if(!h||!h.noUiSlider||!d||d.length===0){console.warn("\u26A0\uFE0F [updateFlowsChart] Period slider or periods not available");return}let[s,o]=h.noUiSlider.get(),r=d.indexOf(s),a=d.indexOf(o),t=d.slice(r,a+1);console.log("\u{1F4CA} [updateFlowsChart] Processing periods:",t);let n=yield Promise.allSettled(t.map(u=>S(F,null,function*(){let[p,m]=u.split("/"),g=2e3+parseInt(m),y=Ue(p),v=ae(p),_=new Date(g,v,0).getDate(),L=yield V("/transactions/totals-v2/",{method:"POST",body:{date_start:`${g}-${y}-01`,date_end:`${g}-${y}-${_}`,include_system:!1}});return console.log(`\u{1F4CA} [updateFlowsChart] ${u} data:`,L),{period:u,income:Math.abs(L.income||0),expenses:Math.abs(L.expenses||0),investments:L.investments||0,balance:L.balance||0}}))),l=[],c=[],i=[];n.forEach((u,p)=>{if(u.status==="fulfilled"){let m=u.value;l.push(m.income),c.push(m.expenses),i.push(m.investments),console.log(`\u2705 [updateFlowsChart] ${m.period}: Income=\u20AC${m.income}, Expenses=\u20AC${m.expenses}, Investments=\u20AC${m.investments}`)}else{let m=t[p],g=ce(m,p,t);l.push(g.income),c.push(g.expenses),i.push(g.investments),console.warn(`\u26A0\uFE0F [updateFlowsChart] Using fallback data for ${m}:`,g)}}),f.flows.data.labels=t,f.flows.data.datasets[0].data=l,f.flows.data.datasets[1].data=c,f.flows.data.datasets[2].data=i,f.flows.data.datasets[0].label="Income (\u20AC)",f.flows.data.datasets[1].label="Expenses (\u20AC)",f.flows.data.datasets[2].label="Investments (\u20AC)",console.log("\u{1F4CA} [updateFlowsChart] Chart updated with transaction totals:",{periods:t.length,totalIncome:l.reduce((u,p)=>u+p,0).toFixed(2),totalExpenses:c.reduce((u,p)=>u+p,0).toFixed(2),totalInvestments:i.reduce((u,p)=>u+p,0).toFixed(2)})}catch(s){console.error("\u274C [updateFlowsChart] Error loading transaction data:",s),yield Le()}f.flows.update("none")}}),ce=(e,s,o)=>{let r=0,a=0,t=0,n=0;if(b.forEach(p=>{let m=parseFloat(p[e])||0,g=(p.type||"").toLowerCase();g.includes("savings")||g.includes("current")?r+=m:g.includes("investment")&&(a+=m)}),s>0){let p=o[s-1];b.forEach(m=>{let g=parseFloat(m[p])||0,y=(m.type||"").toLowerCase();y.includes("savings")||y.includes("current")?t+=g:y.includes("investment")&&(n+=g)})}let l=r-t,c=a-n,i=Math.max(0,l+Math.abs(c)+800),u=Math.max(400,i-l-Math.abs(c));return{income:i,expenses:u,investments:c}},Le=()=>S(F,null,function*(){if(!h||!h.noUiSlider||!d||d.length===0){console.warn("\u26A0\uFE0F [updateFlowsChartFallback] Period slider or periods not available");return}let[e,s]=h.noUiSlider.get(),o=d.indexOf(e),r=d.indexOf(s),a=d.slice(o,r+1),t=[],n=[],l=[];a.forEach((c,i)=>{let u=ce(c,i,a);t.push(u.income),n.push(u.expenses),l.push(u.investments)}),f.flows.data.labels=a,f.flows.data.datasets[0].data=t,f.flows.data.datasets[1].data=n,f.flows.data.datasets[2].data=l,console.log("\u{1F4CA} [updateFlowsChart] Using comprehensive fallback based on balance changes")}),Ue=e=>({Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"})[e]||"01",ae=e=>({Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12})[e]||1,Te=()=>S(F,null,function*(){if(!f.returns||!h||!h.noUiSlider)return;let[e,s]=h.noUiSlider.get(),o=t=>{let[n,l]=t.split("/"),c=2e3+parseInt(l),u=ae(n).toString().padStart(2,"0");return`${c}-${u}`},r=o(e),a=o(s);try{let t=yield fetch(`/dashboard/returns/?start_period=${r}&end_period=${a}`);if(!t.ok)throw new Error("Network response was not ok");let l=(yield t.json()).series||[];if(l.length===0){f.returns.data.labels=["No data"],f.returns.data.datasets[0].data=[0],f.returns.data.datasets[1].data=[0],f.returns.update("none");return}f.returns.data.labels=l.map(c=>c.period),f.returns.data.datasets[0].data=l.map(c=>c.portfolio_return),f.returns.data.datasets[1].data=l.map(c=>c.avg_portfolio_return),f.returns.options.plugins.title.text="Investment Returns Over Time",f.returns.update("none")}catch(t){console.error("\u274C [updateReturnsChart] Failed to load returns data:",t)}}),Ne=()=>S(F,null,function*(){if(!(!f.expenses||!h||!h.noUiSlider)){try{let[e,s]=h.noUiSlider.get(),o=d.indexOf(e),r=d.indexOf(s),a=d.slice(o,r+1);console.log("\u{1F4CA} [updateExpensesChart] Loading real spending data for periods:",a);let t=a[0],n=a[a.length-1],l=p=>{let[m,g]=p.split("/");return`20${g}-${{Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"}[m]}`},c=l(t),i=l(n),u;try{u=yield V("/dashboard/spending-by-category/",{method:"POST",body:{start_period:c,end_period:i}}),console.log("\u{1F4CA} [updateExpensesChart] Real spending data received:",u)}catch(p){console.warn("\u26A0\uFE0F [updateExpensesChart] API failed, using fallback data"),oe();return}if(u.status==="success"&&u.categories&&u.categories.length>0){let p=u.categories.map(g=>g.name),m=u.categories.map(g=>Math.abs(g.total_amount));f.expenses.data.labels=p,f.expenses.data.datasets[0].data=m,console.log("\u2705 [updateExpensesChart] Chart updated with real categories:",{categories:p.length,total:m.reduce((g,y)=>g+y,0).toFixed(2)})}else console.warn("\u26A0\uFE0F [updateExpensesChart] No category data available, using fallback"),oe()}catch(e){console.error("\u274C [updateExpensesChart] Error loading real spending data:",e),oe()}f.expenses.update("none")}}),oe=()=>{let e=[{name:"Uncategorized",amount:800},{name:"General Expenses",amount:600},{name:"Other",amount:200}],s=e.map(r=>r.name),o=e.map(r=>r.amount);f.expenses.data.labels=s,f.expenses.data.datasets[0].data=o,console.log("\u{1F4CA} [updateExpensesChart] Using fallback category data")},Re=e=>{let s=document.getElementById("evolution-chart"),o=document.getElementById("flows-chart"),r=document.getElementById("returns-chart"),a=document.getElementById("expenses-chart");[s,o,r,a].forEach(t=>{t&&(t.style.display="none")}),k=e,e==="evolution"&&s?s.style.display="block":e==="flows"&&o?o.style.display="block":e==="returns"&&r?r.style.display="block":e==="expenses"&&a&&(a.style.display="block"),$()},q=e=>{let s=document.getElementById("insights-container");if(!s||!e.data)return;let o=[],r=e.summary||{};if(r.avg_return&&(r.avg_return>5?o.push({type:"positive",title:"\u{1F680} Exceptional Performance",text:`Your investments are generating ${r.avg_return.toFixed(1)}% per month. Keep up this strategy!`}):r.avg_return<-2?o.push({type:"negative",title:"\u26A0\uFE0F Investment Warning",text:`Return of ${r.avg_return.toFixed(1)}% per month. Consider diversifying or reviewing your strategy.`}):o.push({type:"warning",title:"\u{1F4CA} Moderate Performance",text:`Return of ${r.avg_return.toFixed(1)}% per month. There's room for optimisation.`})),r.avg_expense&&r.avg_income){let t=(r.avg_income-r.avg_expense)/r.avg_income*100;t>30?o.push({type:"positive",title:"\u{1F48E} Exemplary Saver",text:`Savings rate of ${t.toFixed(1)}%. You're on the right path to financial independence!`}):t>15?o.push({type:"warning",title:"\u{1F44D} Good Savings Rate",text:`${t.toFixed(1)}% savings rate. Try to reach 20-30% to accelerate your goals.`}):o.push({type:"negative",title:"\u{1F3AF} Improvement Opportunity",text:`Savings rate: ${t.toFixed(1)}%. Focus on reducing expenses or increasing income.`})}let a=new Date().getMonth();(a===11||a===0)&&o.push({type:"warning",title:"\u{1F384} Watch Seasonal Spending",text:"Holiday season can impact your budget. Stay focused on your financial goals."}),o.length===0&&o.push({type:"info",title:"\u{1F4C8} Keep Adding Data",text:"The more data you add, the more personalised insights we can generate."}),s.innerHTML=o.map((t,n)=>`
      <div class="insight-item insight-${t.type}" data-delay="${n*.1}s">
        <h6 class="mb-2">${t.title}</h6>
        <p class="mb-0">${t.text}</p>
      </div>
    `).join(""),s.querySelectorAll(".insight-item").forEach(t=>{t.style.animationDelay=t.dataset.delay})},de=e=>{if(C&&C.noUiSlider&&C.noUiSlider.destroy(),!C||!e||e.length===0)return;let s,o;e.length===1?(s=e[0],o=e[0]):(s=Math.min(...e),o=Math.max(...e));let r=e.length>1&&o>s?{mode:"count",values:Math.min(5,e.length),density:4,stepped:!0}:{mode:"steps",density:10};noUiSlider.create(C,{start:[s,o],connect:!0,step:1,range:{min:s,max:o},format:{to:n=>Math.round(n),from:n=>parseInt(n)},tooltips:[!0,!0],pips:r});let[a,t]=C.noUiSlider.get();I=[+a,+t],C.noUiSlider.on("update",n=>{I=n.map(l=>parseInt(l))}),C.noUiSlider.on("change",()=>{E=d.filter(n=>{let l=2e3+parseInt(n.split("/")[1]);return l>=I[0]&&l<=I[1]}),se(E,!0,12),$()}),Oe(e)},Oe=e=>{var s,o,r;(s=document.getElementById("prev-year"))==null||s.addEventListener("click",()=>{let a=C.noUiSlider.get(),t=Math.max(e[0],parseInt(a[0])-1),n=Math.max(e[0],parseInt(a[1])-1);C.noUiSlider.set([t,n])}),(o=document.getElementById("next-year"))==null||o.addEventListener("click",()=>{let a=C.noUiSlider.get(),t=Math.min(e[e.length-1],parseInt(a[0])+1),n=Math.min(e[e.length-1],parseInt(a[1])+1);C.noUiSlider.set([t,n])}),(r=document.getElementById("reset-years"))==null||r.addEventListener("click",()=>{C.noUiSlider.set([e[0],e[e.length-1]])})},se=(e,s=!0,o=12)=>{if(!h){console.error("\u274C [initPeriodSlider] Period slider element not found");return}if(console.log("\u{1F527} [initPeriodSlider] Initializing with periods:",e.length),h.noUiSlider&&(console.log("\u{1F5D1}\uFE0F [initPeriodSlider] Destroying existing slider"),h.noUiSlider.destroy()),!e||e.length===0){console.warn("\u26A0\uFE0F [initPeriodSlider] No periods available, creating fallback");let t=new Date,n=t.getFullYear().toString().slice(-2);e=[`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]}/${n}`]}let r=0,a=Math.max(0,e.length-1);s&&e.length>o&&(a=e.length-1,r=Math.max(0,a-(o-1)));try{console.log("\u{1F39B}\uFE0F [initPeriodSlider] Creating noUiSlider with range:",{min:0,max:Math.max(0,e.length-1),start:[r,a],periodsLength:e.length}),noUiSlider.create(h,{start:[r,a],connect:!0,step:1,range:{min:0,max:Math.max(0,e.length-1)},format:{to:i=>e[Math.round(i)]||"",from:i=>e.indexOf(i)},tooltips:[!0,!0],pips:{mode:"steps",density:Math.max(2,Math.floor(100/Math.max(1,e.length))),filter:i=>e.length<=3||i%3===0?1:0,format:{to:i=>{let u=e[Math.round(i)];return u?u.split("/")[0]:""}}}}),console.log("\u2705 [initPeriodSlider] noUiSlider created successfully");let t=e[r]||e[0],n=e[a]||e[e.length-1];document.querySelectorAll(".period-info").forEach(i=>i.remove());let c=document.createElement("div");if(c.className="period-info mt-2 text-center",c.innerHTML=`
        <small class="text-muted">
          \u{1F4C5} Selected: <span id="period-count" class="fw-bold">0</span> periods 
          <span class="ms-2">\u{1F4CA} From <span id="period-start" class="text-primary">${t}</span> to <span id="period-end" class="text-primary">${n}</span></span>
        </small>
      `,h.insertAdjacentElement("afterend",c),console.log("\u2705 [initPeriodSlider] Period count elements created immediately"),e.length>0){console.log("\u{1F3AF} [initPeriodSlider] Setting initial values:",[t,n]),h.noUiSlider.set([t,n]);let i=Math.max(1,a-r+1),u=document.getElementById("period-count");u&&(u.textContent=i,console.log("\u{1F4CA} [initPeriodSlider] Initial period count set:",i))}h.noUiSlider.on("update",i=>{ze(i[0],i[1])}),h.noUiSlider.on("set",$),h.noUiSlider.on("change",$),console.log("\u{1F517} [initPeriodSlider] Event listeners attached"),je(e),console.log("\u2705 [initPeriodSlider] Period slider fully initialized"),$()}catch(t){console.error("\u274C [initPeriodSlider] Error creating slider:",t),h.innerHTML=`
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          Period slider could not be initialized.
          <button class="btn btn-sm btn-outline-primary ms-2" onclick="location.reload()">
            Refresh Page
          </button>
        </div>
      `}},ze=(e,s)=>{try{if(!d||d.length===0){console.warn("\u26A0\uFE0F [updatePeriodCount] No periods available");return}let o=d.indexOf(e),r=d.indexOf(s);if(o===-1||r===-1){console.warn("\u26A0\uFE0F [updatePeriodCount] Invalid period indices:",{start:e,end:s,startIdx:o,endIdx:r});return}let a=Math.max(1,r-o+1),t=document.getElementById("period-range");if(!t){console.warn("\u26A0\uFE0F [updatePeriodCount] Period slider element not found");return}let n=document.getElementById("period-count"),l=document.getElementById("period-start"),c=document.getElementById("period-end");if(!n||!l||!c){console.log("\u{1F527} [updatePeriodCount] Creating/recreating period count elements"),document.querySelectorAll(".period-info").forEach(m=>m.remove());let p=document.createElement("div");p.className="period-info mt-2 text-center",p.innerHTML=`
          <small class="text-muted">
            \u{1F4C5} Selected: <span id="period-count" class="fw-bold">${a}</span> periods 
            <span class="ms-2">\u{1F4CA} From <span id="period-start" class="text-primary">${e}</span> to <span id="period-end" class="text-primary">${s}</span></span>
          </small>
        `,t.insertAdjacentElement("afterend",p),console.log("\u2705 [updatePeriodCount] Created period count elements")}else n&&(n.textContent=a),l&&(l.textContent=e),c&&(c.textContent=s),console.log("\u{1F4CA} [updatePeriodCount] Updated existing elements");let i=document.getElementById("period-count");if(i){let u=i.closest(".period-info");u&&(u.className="period-info mt-2 text-center",a>18?(u.classList.add("text-warning"),i.title="Long period - may affect performance"):a>12?(u.classList.add("text-info"),i.title="Extended period analysis"):(u.classList.add("text-success"),i.title="Optimal period range"))}console.log("\u{1F4CA} [updatePeriodCount] Updated count:",a,`(${e} to ${s})`)}catch(o){console.error("\u274C [updatePeriodCount] Error:",o);try{let r=document.getElementById("period-range");if(r&&!document.getElementById("period-count")){let a=document.createElement("div");a.className="period-info mt-2 text-center",a.innerHTML=`
            <small class="text-muted">
              \u{1F4C5} Period range selected
            </small>
          `,r.insertAdjacentElement("afterend",a),console.log("\u{1F527} [updatePeriodCount] Created fallback period info")}}catch(r){console.error("\u274C [updatePeriodCount] Fallback also failed:",r)}}},je=e=>{var s,o,r,a;(s=document.getElementById("last-3m"))==null||s.addEventListener("click",()=>{if(e.length>=3){let t=e.length-1,n=Math.max(0,t-2);h.noUiSlider.set([e[n],e[t]]),$()}}),(o=document.getElementById("last-6m"))==null||o.addEventListener("click",()=>{if(e.length>=6){let t=e.length-1,n=Math.max(0,t-5);h.noUiSlider.set([e[n],e[t]]),$()}}),(r=document.getElementById("last-12m"))==null||r.addEventListener("click",()=>{if(e.length>=12){let t=e.length-1,n=Math.max(0,t-11);h.noUiSlider.set([e[n],e[t]]),$()}}),(a=document.getElementById("all-periods"))==null||a.addEventListener("click",()=>{e.length>0&&(h.noUiSlider.set([e[0],e[e.length-1]]),$())})},We=()=>{if(!(!b.length||!h))try{let[e,s]=h.noUiSlider.get(),o=d.indexOf(e),r=d.indexOf(s),a=d.slice(o,r+1),t=["type","currency",...a],n=document.getElementById("balance-header-top"),l=document.getElementById("balance-header-bottom"),c=document.querySelector("#balance-table tbody");if(!n||!l||!c)return;n.innerHTML="",l.innerHTML="",c.innerHTML="",["Type","Currency"].forEach(p=>{let m=document.createElement("th");m.rowSpan=2,m.textContent=p,m.className="text-center",n.appendChild(m)});let i={};a.forEach(p=>{let[m,g]=p.split("/"),y="20"+g;i[y]=i[y]||[],i[y].push(p)}),Object.entries(i).forEach(([p,m])=>{let g=document.createElement("th");g.colSpan=m.length,g.textContent=p,g.className="text-center bg-light fw-bold",n.appendChild(g)}),Object.values(i).flat().forEach(p=>{let m=document.createElement("th");m.textContent=p.split("/")[0],m.className="text-center",l.appendChild(m)}),b.forEach(p=>{let m=document.createElement("tr");m.className="table-row-hover",t.forEach(g=>{var _;let y=document.createElement("td"),v=(_=p[g])!=null?_:0;g==="type"||g==="currency"?(y.textContent=v||"\u2013",y.className="fw-bold"):(y.textContent=typeof v=="number"?B(v):"\u2013",y.className="text-end",typeof v=="number"&&(v>1e3?y.classList.add("text-success","fw-bold"):v>0?y.classList.add("text-success"):v<0&&y.classList.add("text-danger"))),m.appendChild(y)}),c.appendChild(m)});let u=document.createElement("tr");u.className="table-warning fw-bold border-top border-2",t.forEach(p=>{let m=document.createElement("td");if(p==="type")m.textContent="GRAND TOTAL",m.className="fw-bold text-uppercase";else if(p==="currency")m.textContent="EUR",m.className="fw-bold";else{let g=a.includes(p)?b.reduce((y,v)=>{let _=v[p];return y+(_!=null?+_:0)},0):0;m.textContent=B(g),m.className="text-end fw-bold",g>0&&m.classList.add("text-success")}u.appendChild(m)}),c.appendChild(u)}catch(e){console.error("\u274C Erro ao atualizar tabela:",e)}},Ye=()=>{},$=()=>S(F,null,function*(){var e,s,o,r,a,t;if(!(!h||!b.length||!X))try{console.log("\u{1F504} Atualizando dashboard...");let[n,l]=h.noUiSlider.get(),c=d.indexOf(n),i=d.indexOf(l),u=d.slice(c,i+1),p=(s=(e=document.getElementById("include-savings"))==null?void 0:e.checked)!=null?s:!0,m=(r=(o=document.getElementById("include-investments"))==null?void 0:o.checked)!=null?r:!0,g=(t=(a=document.getElementById("include-current"))==null?void 0:a.checked)!=null?t:!0,y=[Ae(),We()];Promise.all(y).then(()=>{console.log("\u2705 Fast updates completed")});let v=n&&l?H(n,l):Promise.resolve(),_=_e(u,p,m,g);q(_),yield Promise.all([...y,v]),console.log("\u2705 Dashboard atualizado")}catch(n){console.error("\u274C Erro ao atualizar dashboard:",n)}});(fe=document.getElementById("apply-filters"))==null||fe.addEventListener("click",$),["analysis-period","show-trends","include-savings","include-investments","include-current"].forEach(e=>{let s=document.getElementById(e);s&&s.addEventListener("change",o=>{console.log(`\u{1F504} [${e}] Filtro alterado:`,o.target.checked||o.target.value),$()})});let Y=document.getElementById("smart-search-input"),ue=document.getElementById("smart-search-btn"),me=e=>S(F,null,function*(){if(!e)return;e=e.toLowerCase().trim(),console.log("\u{1F50D} Executing smart search for:",e);let[s,o]=h.noUiSlider.get(),r=d.indexOf(s),a=d.indexOf(o),t=d.slice(r,a+1);if(e.match(/^\d{4}$/)){let n=parseInt(e),l=`${d.filter(i=>2e3+parseInt(i.split("/")[1])===n)[0]}`,c=`${d.filter(i=>2e3+parseInt(i.split("/")[1])===n)[d.filter(i=>2e3+parseInt(i.split("/")[1])===n).length-1]}`;l&&c&&h.noUiSlider.set([l,c])}else if(e.startsWith("last ")){let n=e.split(" ");if(n.length===3&&n[2]==="months"){let l=parseInt(n[1]);if(l&&!isNaN(l)&&t.length>=l){let c=t.length-1,i=Math.max(0,c-(l-1));h.noUiSlider.set([t[i],t[c]])}}else if(e==="current year"){let l=new Date().getFullYear(),c=d.filter(i=>2e3+parseInt(i.split("/")[1])===l);c.length>0&&h.noUiSlider.set([c[0],c[c.length-1]])}}else if(e.includes(" to ")){let[n,l]=e.split(" to ");d.includes(n.trim())&&d.includes(l.trim())&&h.noUiSlider.set([n.trim(),l.trim()])}else if(e.match(/^q[1-4]$/)){let n=parseInt(e[1]),l=parseInt(t[0].split("/")[1]),c,i;n===1?(c=0,i=2):n===2?(c=3,i=5):n===3?(c=6,i=8):n===4&&(c=9,i=11);let u=d.filter(p=>{let m=ae(p.split("/")[0]);return m>=c+1&&m<=i+1});u.length>0&&h.noUiSlider.set([u[0],u[u.length-1]])}Y.value=""});Y&&ue&&(ue.addEventListener("click",()=>me(Y.value)),Y.addEventListener("keypress",e=>{e.key==="Enter"&&me(Y.value)}));let pe=document.querySelectorAll(".filter-preset-btn");pe.forEach(e=>{e.addEventListener("click",()=>{var o,r,a,t;let s=e.dataset.period;s&&h&&h.noUiSlider&&(s==="last_3m"?(o=document.getElementById("last-3m"))==null||o.click():s==="last_6m"?(r=document.getElementById("last-6m"))==null||r.click():s==="last_12m"?(a=document.getElementById("last-12m"))==null||a.click():s==="all"&&((t=document.getElementById("all-periods"))==null||t.click()),pe.forEach(n=>n.classList.remove("active")),e.classList.add("active"))})});let ge=ke($,200);C&&C.addEventListener("noUiSlider-set",ge),h&&h.addEventListener("noUiSlider-set",ge),(he=document.getElementById("refresh-data"))==null||he.addEventListener("click",()=>S(F,null,function*(){document.querySelectorAll(".kpi-card").forEach(e=>{e.style.opacity="0.7"}),yield ee(),yield H(),yield te(),document.querySelectorAll(".kpi-card").forEach(e=>{e.style.opacity="1"})})),(be=document.getElementById("reset-filters"))==null||be.addEventListener("click",()=>{var t;console.log("\u{1F504} Resetting all filters to default values");let e=document.getElementById("analysis-period");e&&(e.value="monthly");let s=document.getElementById("show-trends");s&&(s.checked=!1);let o=document.getElementById("include-savings");o&&(o.checked=!0);let r=document.getElementById("include-investments");r&&(r.checked=!0);let a=document.getElementById("include-current");if(a&&(a.checked=!0),C&&C.noUiSlider&&w.length>0&&(console.log("\u{1F504} Resetting year slider to full range:",[w[0],w[w.length-1]]),C.noUiSlider.set([w[0],w[w.length-1]])),h&&h.noUiSlider&&d.length>0){let n=d.length-1,l=Math.max(0,n-11);console.log("\u{1F504} Resetting period slider to last 12 months:",[d[l],d[n]]),h.noUiSlider.set([d[l],d[n]])}M=null,Q=0,N.clear(),document.querySelectorAll(".filter-preset-btn").forEach(n=>n.classList.remove("active")),(t=document.querySelector('.filter-preset-btn[data-period="last_12m"]'))==null||t.classList.add("active"),console.log("\u2705 All filters reset, updating dashboard"),$()}),document.querySelectorAll("[data-chart]").forEach(e=>{e.addEventListener("click",s=>{document.querySelectorAll("[data-chart]").forEach(r=>r.classList.remove("active")),s.target.classList.add("active");let o=s.target.dataset.chart;Re(o),console.log("Switching to chart:",o)})}),(ye=document.getElementById("export-excel"))==null||ye.addEventListener("click",()=>{window.location.href="/account-balance/export/"}),(ve=document.getElementById("export-pdf"))==null||ve.addEventListener("click",()=>{window.print()}),(xe=document.getElementById("backup-data"))==null||xe.addEventListener("click",()=>{window.location.href="/transactions/export-excel/"});let Je=()=>S(F,null,function*(){if(X){console.log("\u26A0\uFE0F Dashboard already initialized, ignoring");return}console.log("\u{1F680} Initializing dashboard..."),X=!0;try{Pe()}catch(e){console.error("\u274C Error initializing charts:",e)}try{console.log("\u{1F4CA} Loading data...");let e=yield ee(!1).catch(o=>(console.warn("\u26A0\uFE0F Failed to load balances, using mock data"),W())),s=yield H().catch(o=>(console.warn("\u26A0\uFE0F Failed to load KPIs, using mock data"),R()));te().catch(o=>(console.warn("\u26A0\uFE0F Failed to load analysis, using simulated data"),ne())),console.log("\u2705 Data loaded")}catch(e){console.error("\u274C Error during initialization:",e),x=["type","currency"],b=[],d=[],w=[new Date().getFullYear()],O(R())}console.log("\u2705 Dashboard inicializado")}),rt=()=>S(F,null,function*(){try{yield V("/sync-system-adjustments/",{method:"POST"}),console.log("\u2705 System adjustments synchronized successfully."),yield ee(),yield H(),yield te(),$()}catch(e){console.error("\u274C Failed to synchronize system adjustments:",e)}});Je()})});tt();})();
